<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Tree Clipper</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="login-corner"></div>
    <a href="/" class="back-button">‚Üê</a>
    
    <div id="user-header" class="user-header">
        <h1 id="username-display" style="color: #232323;">&nbsp;</h1>
        <p id="user-meta" class="user-meta"></p>
    </div>
    
    <div id="user-stats" class="user-stats" style="display: none;">
        <span id="asset-count" class="stat-badge"></span>
    </div>
    
    <ul id="user-assets-list" class="assets-list">
        <li class="loading-item">Loading assets...</li>
    </ul>

    <script type="module">
        async function loadUserProfile() {
            // Parse username from clean URL path: /:username
            const pathParts = window.location.pathname.split('/').filter(Boolean);
            
            if (pathParts.length !== 1 || pathParts[0].includes('.')) {
                showError("Invalid user profile URL");
                return;
            }
            
            const username = decodeURIComponent(pathParts[0]).toLowerCase();
            
            // Fetch user info
            try {
                const userRes = await fetch(`/api/users/${encodeURIComponent(username)}`);
                
                if (!userRes.ok) {
                    if (userRes.status === 404) {
                        showError("User not found");
                        return;
                    }
                    throw new Error(`HTTP ${userRes.status}`);
                }
                
                const user = await userRes.json();
                
                // Update page title and header
                document.title = `@${user.username} - Tree Clipper`;
                document.getElementById("username-display").textContent = `@${user.username}`;
                
                // Show member since date
                if (user.created_at) {
                    const memberSince = formatDate(user.created_at);
                    document.getElementById("user-meta").textContent = `Member since ${memberSince}`;
                }
                
            } catch (err) {
                console.error("Failed to load user:", err);
                // Still try to load assets even if user info fails
                document.getElementById("username-display").textContent = `@${username}`;
            }
            
            // Fetch user's assets
            try {
                const assetsRes = await fetch(`/api/entries?author=${encodeURIComponent(username)}`);
                
                if (!assetsRes.ok) {
                    throw new Error(`HTTP ${assetsRes.status}`);
                }
                
                const entries = await assetsRes.json();
                const listEl = document.getElementById("user-assets-list");
                const statsEl = document.getElementById("user-stats");
                const countEl = document.getElementById("asset-count");
                
                if (!entries || entries.length === 0) {
                    listEl.innerHTML = '<li class="empty-item">No assets yet.</li>';
                    return;
                }
                
                // Show stats
                statsEl.style.display = "flex";
                const assetWord = entries.length === 1 ? 'asset' : 'assets';
                countEl.textContent = `${entries.length} ${assetWord}`;
                
                listEl.innerHTML = entries.map(entry => {
                    const title = entry.title || "Untitled Asset";
                    const imageUrl = entry.image_data;
                    const imageHtml = imageUrl 
                        ? `<img src="${escapeHtml(imageUrl)}" alt="" class="asset-thumb" loading="lazy">`
                        : `<div class="asset-thumb-placeholder">üì¶</div>`;
                    
                    // Build tags HTML
                    let tagsHtml = '';
                    if (entry.node_type || entry.blender_version) {
                        tagsHtml = '<div class="asset-tags">';
                        if (entry.node_type) {
                            const nodeLabel = formatNodeType(entry.node_type);
                            const nodeIcon = getNodeTypeIcon(entry.node_type);
                            tagsHtml += `<span class="asset-tag asset-tag--${entry.node_type}">${nodeIcon} ${nodeLabel}</span>`;
                        }
                        if (entry.blender_version) {
                            tagsHtml += `<span class="asset-tag asset-tag--blender">Blender ${escapeHtml(entry.blender_version)}</span>`;
                        }
                        tagsHtml += '</div>';
                    }
                    
                    const assetUrl = `/${encodeURIComponent(entry.author)}/${encodeURIComponent(entry.slug)}`;
                    
                    return `
                        <li>
                            <a href="${assetUrl}">
                                ${imageHtml}
                                <div class="asset-info">
                                    <span class="asset-title">${escapeHtml(title)}</span>
                                    <span class="asset-date">${formatDate(entry.creation_date)}</span>
                                    ${tagsHtml}
                                </div>
                            </a>
                        </li>
                    `;
                }).join('');
                
            } catch (err) {
                console.error("Failed to load assets:", err);
                document.getElementById("user-assets-list").innerHTML = 
                    '<li class="error-item">Failed to load assets. Please try again later.</li>';
            }
        }
        
        function showError(message) {
            document.getElementById("username-display").textContent = message;
            document.getElementById("user-meta").textContent = "";
            document.getElementById("user-assets-list").innerHTML = '';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(isoString) {
            if (!isoString) return "";
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function formatNodeType(nodeType) {
            const labels = {
                'geonodes': 'Geo Nodes',
                'shader': 'Shader',
                'compositor': 'Compositor'
            };
            return labels[nodeType] || nodeType;
        }
        
        function getNodeTypeIcon(nodeType) {
            const icons = {
                'geonodes': '‚óá',
                'shader': '‚óê',
                'compositor': '‚ñ£'
            };
            return icons[nodeType] || '‚óè';
        }
        
        loadUserProfile();
    </script>
    
    <script type="module" src="/auth.js"></script>
    
    <div class="prototype-warning">Early Prototype, data not yet persistent</div>
</body>
</html>
